# Bitbucket Pipeline file

# This template allows you to validate your PHP application.
# The workflow allows running tests and code linting on the default branch.

pipelines:
  branches:
    docker-release:
      - step:
          name: Build
          runs-on:
            - self.hosted
            - linux
          script:
            # Без строк ниже ничего не сработает (В битбакете нету docker-compose по умолчанию, Runner тоже в этом нуждается)
            - sudo apt -y install curl
            - sudo curl -L "https://github.com/docker/compose/releases/download/v2.4.1/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            - sudo chmod +x /usr/local/bin/docker-compose
            - sudo docker-compose --version

            # Экспоритруем переменные зашитые в битбакет для разветки
            - echo DB_NAME=$DB_NAME > .env
            - echo DB_USER=$DB_USER >> .env
            - echo DB_PASSWORD=$DB_PASSWORD >> .env

            - echo "Собираем Docker контейнеры"

            - sudo systemctl start docker

            # Запускаем контейнеры приложения в фоновом режиме
            - sudo docker-compose up -d

            - echo "Обновляем зависимости composer"

            # Обновляем зависимости композера
            - sudo docker-compose exec -T app composer install --no-interaction