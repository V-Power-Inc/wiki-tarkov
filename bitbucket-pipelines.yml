# Bitbucket Pipeline file

# This template allows you to validate your PHP application.
# The workflow allows running tests and code linting on the default branch.
image: docker/compose:latest

options:
  docker: true

pipelines:
  branches:
    docker-release:
      - step:
          name: Build
          services:
            - docker
          caches:
            - docker
          runs-on:
            - self.hosted
            - linux
          script:
            # Экспоритруем переменные зашитые в битбакет для развертки
            - echo "Экспоритруем переменные зашитые в битбакет для развертки"
            - echo DB_NAME=$DB_NAME > .env
            - echo DB_USER=$DB_USER >> .env
            - echo DB_PASSWORD=$DB_PASSWORD >> .env
            - echo REDIS_HOST=$REDIS_HOST >> .env
            - echo DB_DSN=$DB_DSN >> .env
            - echo DB_TEST_DSN=$DB_TEST_DSN >> .env
            - echo DB_TEST_CHARSET=$DB_TEST_CHARSET >> .env
            - echo DB_CHARSET=$DB_CHARSET >> .env
            - echo DOMAIN=$DOMAIN >> .env
            - echo DOMAIN_PROTOCOL=$DOMAIN_PROTOCOL >> .env
            - echo DB_TEST_NAME=$DB_TEST_NAME >> .env
            - echo DB_TEST_USER=$DB_TEST_USER >> .env
            - echo DB_TEST_PASSWORD=$DB_TEST_PASSWORD >> .env

            - echo "Собираем Docker контейнеры"

            # Build docker containers (Пока убрали чтобы сборки быстрее проходили)
            # - docker-compose build

            # Запускаем контейнеры приложения в фоновом режиме
            - docker-compose up -d

            - echo "Обновляем зависимости composer"

            # Обновляем зависимости композера
            - docker-compose exec -T app composer install --no-interaction

            - echo "Даем больше прав юзеру MySQL для создания триггеров"

            # Даем prod_user MySQL все необходимые права, а также создаем новую базу для миграций
            # - docker exec -t db /bin/bash
            - docker exec -t db mysql -u root -p$DB_PASSWORD --execute "use dev_eft;
              CREATE DATABASE test_migrations_db;
              GRANT SUPER ON *.* to 'prod_user'@'%' WITH GRANT OPTION;
              GRANT ALL PRIVILEGES ON dev_eft.* to 'prod_user'@'%' WITH GRANT OPTION;
              GRANT ALL PRIVILEGES ON test_migrations_db.* to 'prod_user'@'%' WITH GRANT OPTION;"


            #            - docker exec -t db mysql -u root -p$DB_PASSWORD -e GRANT SUPER ON . to 'prod_user'@'%' WITH GRANT OPTION;
            #            - docker exec -t db mysql -u root -p$DB_PASSWORD -e GRANT ALL PRIVILEGES ON dev_eft.* to 'prod_user'@'%' WITH GRANT OPTION;
            #            - docker exec -t db mysql -u root -p$DB_PASSWORD -e CREATE DATABASE test_migrations_db;
            #            - docker exec -t db mysql -u root -p$DB_PASSWORD -e GRANT SUPER ON . to 'prod_user'@'%' WITH GRANT OPTION;
            #            - docker exec -t db mysql -u root -p$DB_PASSWORD -e GRANT ALL PRIVILEGES ON test_migrations_db.* to 'prod_user'@'%' WITH GRANT OPTION;


            # Накатываем миграции на dev_eft
            - echo "Накатываем миграции на dev_eft"

            - docker-compose exec -T app php yii migrate --interactive=0

            # Накатываем миграции на test_migrations_db
            - echo "Накатываем миграции на test_migrations_db"

            - docker-compose exec -T app php yii migrate --db test_db --interactive=0;

            # Накатываем миграции
            # todo: Пробуем накатить тут миграции (В bitbucket сейчас dsn_db установлено как db_1 - по умолчанию db)