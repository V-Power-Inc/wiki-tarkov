# Wiki Tarkov Project

## Описание
Проект Wiki Tarkov - это версия базы знаний по игре Escape From Tarkov. Разрабатывался с 10 октября 2017г., претерпел множество изменений на пути своего становления. В августе 2022г. был проведен глобальный рефакторинг проекта. В настоящий момент пример проекта можно увидеть на домене: https://wiki-tarkov.ru

Проект реализован на фреймворке Yii2, в качестве веб-сервера используется Nginx. База данных на MariaDb. Реализована концепция CI/CD и автодеплой с помощью в Production ветку bitbucket pipelines. В проекте также присутствует docker инструкция для развертывания в том числе на локальном устройстве.

Проект приносит прибыль с помощью показов рекламы, полученной от РСЯ (Рекламная сеть Яндекса)

Проект включает в себя следующие модули:

- Описания торговцев по игре Escape From Tarkov. Детальные таблицы торговцев с предметами, которые вы можете купить у них на 4-х уровнях репутации.
- Квесты, которые необходимо выполнять для торговцев для повышения репутации.
- Справочник лута, который включает в себя более 900 позиций с детальной 2-х уровневой категоризацией и привязкой позиций к квестам торговцев.
- Справочник ключей - база знаний с детальной информацией о видах ключей, для открывания различных помещений.
- Справочник умений - содержит в себе подробную информацию о доступных умениях, влияниях умений а также различных способах их прокачки.
- Новостной раздел - раздел новостей на сайте, с вебхуком для пуша новости в специальный раздел сервера Discord.
- Интерактивные карты локаций - карты локаций по игре, с огромным количеством различных маркеров с информацией по различным секретным местам.
- Список кланов - раздел, позволяющий зарегистрировать на сайте свой собственный клан с логотипом и ссылкой на сообщество. Также поддерживается возможность смотреть уже добавленные кланы (Только те, которые прошли модерацию).
- Раздел "Часто задаваемые вопросы" - содержит список всех часто задаваемых вопросов и ответы на них.
- Курсы валют - раздел для просмотра курсов валют евро, биткоина и доллара во внутриигровом мире, используется JS для мгновенного получения результата без перезагрузки страницы.
- Админка - написанная с нуля модульная Yii2 админка, которая необходима для администрирования сайта.
## Yii2 basic reworked 
В процессе разработки использовалась Yii2 basic, однако под нужды проекта она была доработана, в связи с чем в проекте появились некоторые нюансы.

> ``Важно:`` Была создана папка **common** в корне проекта (по аналогии с Yii2 Advanced шаблоном), куда были вынесены все необходимые изменения

В папке common структура папок следующая:
- controllers - контроллеры и трейты наследованные от базовых Yii'шных контроллеров
- services - сервисы, для реализации различной логики
- interfaces - папка с интерфейсами собственного производства
- helpers - собственные классы хелперов наследованные от базовых Yii'шных

Также в папке common присутствует env.php файл, который помогает инициализировать DotEnv и указывает, какие переменные проекта являются критичными.

> ``Важно:``  В директорию config/web был добавлен файл bootstrap.php, в котором прописана логика, которая должна стать доступна до инициализации приложения.

Вышеупомянутое стало возможно благодаря добавлению кода:

    require __DIR__ . '/config/bootstrap.php';

В файл yii.php до секций:

    $application = new yii\console\Application($config);
    $exitCode = $application->run();
Это позволяет запустить файл с предустановками до инициализации приложения, такой подход пригодился в том числе по той причине, что был изменен стандартный Url менеджер на более продвинутый, с собственными доработками.  

## Измененный Url менеджер 

В этой версии приложения, мы изменили принцип работы Url менеджера, чтобы это стало возможно, были созданы следующие файлы:
 - common/controllers/AdvancedController - наследуется от базового Yii контроллера и использует трейт (Для клиентской части сайта)
 - common/controllers/AdminController - наследуется от базового Yii контроллера и использует трейт (Для админки)
 - common/controllers/ControllerRoutesTrait - трейт для вышеупомянутых контроллеров

Суть этого подхода в том, чтобы для бекенда и фронтенда использовались разные контроллеры, со своей логикой, но при этом чтобы у каждого из них была возможность использовать некий функционал, который сделал бы Url менеджер более прозрачным.

В трейте ControllerRoutesTrait содержатся 2 метода:


    public static function getUrlRoute(string $action, array $params = []): array
    public static function routeId(string $action): string

**getUrlRoute** при мередаче ему имени экшена, создает урлы вида controllerId/ActionId, также отлично работает и с модульными путями, его мы всегда будет вызывать при указании маршрутов в логике.
**routeId** - этот метод делает тоже самое, что и верхний, но используется исключительно в файле маршрутов.

Т.к. показалось, что писать все маршруты приложения в config/web.php это избыточно, в директории config был создан новый файл routes.php
Пример того, как теперь может выглядеть config/web/routes.php:

    <?php  
    /** Отдельный файл routes - сюда для удобства были вынесены все маршруты */  
      
    use app\modules\admin\controllers\DefaultController;  
    use app\modules\admin\controllers\ModeratorController;  
      
    use app\controllers\SiteController;  
      
    return [  
      'admin/login' => DefaultController::routeId(DefaultController::ACTION_LOGIN),  
      'admin/logout' => DefaultController::routeId(DefaultController::ACTION_LOGOUT),  
      'admin/ass-destroyer' => ModeratorController::routeId(ModeratorController::ACTION_INDEX),  
      
      '' => SiteController::routeId(SiteController::ACTION_INDEX),  
    ];

Такое возможно, благодаря наследованию всех новых контроллеров от AdvancedController или AdminController в зависимости от потребностей.

В константах классов пишется та часть, которая обычно в названии метода контроллера идет после слова action, например для метода:

    public function actionTest()
Константа в контроллере будет такой:

    const ACTION_TEST = 'test'

Если мы это делали скажем в ExampleController, то строка в файле route должна быть примерно такой:

    'testing-page' => ExampleController::routeId(ExampleController::ACTION_TEST)

Преимущество этого константного подхода в том, что если какой-либо url адрес поменяется нам не придется лазать по всему проекту, в бесконечных попытках произвести все замены (Учитывать кейс отсутствия PhpStorm в том числе).
## Миграции
Для проекта были написаны все необходимые миграции, с комментариями на каждую таблицу и каждое поле, добавлением индексов и внешних ключей, также были созданы триггеры для автообновления полей на некоторые таблицы.

Всего в проекте 40 миграций для базы данных. Миграции могут быть применены с помощью команды в корневой директории проекта:

    php yii migrate


## Functional&Unit тестирование
В проекте реализовано функциональное и Unit тестирование с использованием Codeception. Всего написано 260 методов тестирования с 1057 ожиданиями определенных результатов. В процессе тестирования использовались фикстуры для баз данных, как независимые, так и взаимосвязанные.
Unit тестирование было написано исключительно для таблиц баз данных. Функциональное для проверки работоспособности функционала как ожидается (Рендеринг страниц, определенные результаты на ней, реклама и кукисы).

Тестирование было разработано для следующего функционала:

 - Интерактивные карты
 - Квесты торговцев
 - Детальные страницы торговцев
 - Справочник лута
 - Категории справочника лута
 - Детальные страницы справочника лута

Вышеупомянутый функционал составляет примерно 70% проекта.


